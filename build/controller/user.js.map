{"version":3,"sources":["../../src/controller/user.js"],"names":["UserController","data","userObj","token","Promise","resolve","reject","userModel","findOne","email","then","userData","bcrypt","compare","password","toString","err","isMatch","code","msg","equal","tokenObj","userId","jwt","sign","secret","expiresIn","finalOutput","catch","newUser","save","savedUser","oldPassword","matched","genSalt","salt","hash","newPassword","findOneAndUpdate"],"mappings":"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","file":"user.js","sourcesContent":["import userModel from '../models/user';\r\nimport uuidv4 from 'uuid/v4';\r\nimport jwt from 'jsonwebtoken';\r\nimport bcrypt from 'bcrypt-nodejs';\r\nimport cred from '../config/const'\r\nimport uuidv3 from 'uuid/v3';\r\n// import logger from '../utils/logger';\r\n\r\nclass UserController {\r\n\r\n    constructor() {\r\n\r\n    }\r\n\r\n\r\n    login(data) {\r\n        let userObj;\r\n        let token;\r\n        return new Promise((resolve, reject) => {\r\n\r\n            userModel.findOne({ email: data.email })\r\n                .then((userData) => {\r\n                    if (userData) {\r\n                        userObj = userData;\r\n                        return new Promise((resolve, reject) => {\r\n                            bcrypt.compare(data.password.toString(), userData.password, (err, isMatch) => {\r\n                                if (err)\r\n                                    reject(err);\r\n                                resolve(isMatch)\r\n                            })\r\n                        })\r\n                    } else {\r\n                        reject({ code: 400, msg: 'No User found' });\r\n                    }\r\n                })\r\n                .then((equal) => {\r\n                    if (equal) {\r\n                        return true\r\n                    } else {\r\n                        reject({ code: 400, msg: 'No Password matched' });\r\n                    }\r\n                })\r\n                .then((isMatch) => {\r\n                    let tokenObj = {\r\n                        userId: userObj.userId\r\n                    };\r\n                    token = jwt.sign(tokenObj, cred().secret, { expiresIn: '24h' });\r\n                    return token\r\n                })\r\n                .then((token) => {\r\n                    let finalOutput = {\r\n                        'status': 'authorized',\r\n                        'userId': userObj.userId,\r\n                        'email': userObj.email,\r\n                        'sessionToken': token,\r\n                        'expiresIn': '24h'\r\n                    };\r\n                    resolve(finalOutput);\r\n                })\r\n                .catch((err) => {\r\n                    reject({ code: 500, msg: err });\r\n                });\r\n        })\r\n    }\r\n\r\n    register(data) {\r\n        return new Promise((resolve, reject) => {\r\n            let newUser = new userModel();\r\n            newUser.email = data.email;\r\n            newUser.password = data.password;\r\n            newUser.userId = uuidv4();\r\n            newUser.save((err, savedUser) => {\r\n                if (err) {\r\n                    reject({ code: 500, msg: err });\r\n                } else {\r\n                    resolve(savedUser);\r\n                }\r\n            })\r\n        })\r\n    }\r\n\r\n\r\n    changePassword(data) {\r\n        return new Promise((resolve, reject) => {\r\n            userModel.findOne({ userId: data.userId }, { password: 1 }).then((userData) => {\r\n                if (userData) {\r\n                    return new Promise((resolve, reject) => {\r\n                        bcrypt.compare(data.oldPassword.toString(), userData.password, (err, isMatch) => {\r\n                            if (err)\r\n                                reject(err);\r\n                            resolve(isMatch)\r\n                        })\r\n                    })\r\n                } else {\r\n                    reject({ code: 500, msg: 'unauthorized action.' })\r\n                }\r\n            })\r\n                .then((equal) => {\r\n                    if (equal) {\r\n                        return true\r\n                    } else {\r\n                        reject({ code: 400, msg: 'No Password matched' });\r\n                    }\r\n                })\r\n                .then((matched) => {\r\n                    bcrypt.genSalt(10, (err, salt) => {\r\n                        if (err)\r\n                            reject({ code: 500, msg: 'something went wrong.' })\r\n                        bcrypt.hash(data.newPassword, salt, null, (err, hash) => {\r\n                            if (err)\r\n                                reject({ code: 500, msg: 'something went wrong.' })\r\n\r\n                            data.newPassword = hash;\r\n                            userModel.findOneAndUpdate({ userId: data.userId }, { password: data.newPassword }).then((data) => {\r\n                                resolve(null);\r\n                            }).catch((err) => {\r\n                                reject({ code: 500, msg: err });\r\n                            })\r\n                        });\r\n                    });\r\n\r\n                })\r\n                .catch((err) => {\r\n                    reject({ code: 500, msg: err });\r\n                })\r\n        })\r\n\r\n    }\r\n}\r\n\r\nexport default new UserController();"]}